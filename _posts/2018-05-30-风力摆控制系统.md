---
layout: post
title: 基于STM32单片机-风力摆控制系统
date: 2018-05-30
tag: 一些作品的心得、论文及源码
---   

## 摘要：

　　本系统采用STM32F103V开发板作为控制中心，与万向节、摆杆、直流风机（无刷电机+扇叶）、激光头、反馈装置一起构成摆杆运动状态与风机速度分配的双闭环调速系统。单片机输出可变的PWM波给电机调速器，控制4个方向上风机的风速，从而产生大小不同的力。利用加速度计模块MPU6050，准确测出摆杆移动的位置与中心点位置之间的关系，采样后反馈给单片机，使风机及时矫正，防止脱离运动轨迹。使用指南针模块判别方向，控制系统向指定方向偏移。控制方式采用PID算法，比例环节进行快速响应，积分环节实现无静差，微分环节减小超调，加快动态响应。从而使该系统具有良好的性能，能很好地实现自由摆运动、快速制动静止、画圆、指定方向偏移，具有很好地稳定性。

　　关键词：STM32F103V、空心杯电机、MPU6050、PID。

## 正文：

#### 一、系统方案

* 1.1 系统基本方案

1.1.1 控制方案设计

　　为了实现题目要求我们采用STM32F103V单片机做为主控芯片，用加速度计陀螺仪模块MPU6050来计算角度和风机状态，用直流风机带动摆杆运动。当MPU6050检测到摆杆的角度时，可根据三角函数公式计算出摆杆现在距离中心的具体位置（方向、距离），单片机会控制PWM波的输出大小来控制风机的风速与方向，使摆杆达到在特定位置静止或按照一定的轨迹运动。当摆杆处于自然下垂状态时，给四个风机同时上电且风向都向外，此时摆杆仍处于受力平衡——静止状态。此时降低X轴上一个风机的转速，摆杆将会带动激光头在X轴上画一条直线，当达到一定的倾斜角度时，单片机可根据角度计算出此时距离中心的距离是否>=25cm，若达到要求后，此风机减速，X轴反方向上电机逐渐加速，恢复到初始速度，反方向做相同的运动。在此过程中，单片机做出A/D采样，Y轴方向方向风机随时做出矫正，防止发生轨迹偏移。角度传感器控制系统框图如图1所示。
<div align="center">
	<img src="/images/posts/fenglibai/1.png" height="200" width="500">  
</div>

1.1.2 机械结构方案设计

　　由于摆杆长度（60cm~70cm）较长，且要求激光头在地面画出15cm~35cm的圆，所以要求横杆的距离要足够长。横杆长度较长加之摆杆重量较大，所以要求底座要有足够的重量来支撑整个系统。如果结构不稳或者重量不够，摆杆运动过程中将会产生倾倒或者抖动等现象，影响测试结果。于是，底座采用了“工”型结构，保证了整个系统的稳定性。摆杆材料方面，我们选用轻便的硬质铁质材料与风机进行刚性连接，既能保证连接处的稳定，又可达到减轻底座负担的目的。风机选择方面，既要保证风力够大，能够实现题目基本要求中的自由摆运动、快速制动静止。又要有一定的重量，质量越大，惯性越大，越不容易改变原来的运动状态，在实现发挥功能时，受到外界干扰，不容易改变原来的圆周运动状态机械结构如图2。
<div align="center">
	<img src="/images/posts/fenglibai/2.png" height="200" width="500">  
</div>
1.底座；2.竖杆；3.横杆；4.螺栓；5.万向节；6.摆杆；7.风机（1）；8.风机（2）；9.风机（3）；10.风机（4）

* 1.2 各部分方案选择与论证

1.2.1电机选择

　　方案一： 采用小型轴流风机（大功率），使用双滚珠轴承，采用滚动摩擦的形式，轴承中有数颗微小钢珠围绕轴心，当扇叶转动时，钢珠即跟着转动。因为都是球体，摩擦力较小，所以转速较高。能达到8000RMP，同时产生较大的风力。风机内力矩较大，是因为机内绕了大量的铜线，导致重量较大，当4个风机固定到一起时，重量更大，风机产生的风力带动风机运动困难加大，更难做到题目中按要求运动。另一方面，此风机功率较大，所需电流较大，驱动与供电方面也有很大问题。

　　方案二：采用无刷电机，风力较大，重量适中，能达到题目运动状态要求，速度控制精确，但须配套电机调速器，价格较贵。

　　方案三： 采用双环强磁空心杯电机，重量较轻，内部使用强磁，转速较高。风力也足够大，基本能达到要求。而且其性价比较高，容易驱动。

综合考虑，我们选择方案三。

1.2.2 电机驱动的选择

　　由于上述电机选择了双环强磁空心杯电机，此驱动选择了ULN2003芯片自制驱动。

1.2.3 摆杆与横杆的连接选择

　　方案一：摆杆使用粗单股导线直接与横杆连接，连接简单且自由度较好，给风机供电等方面都比较容易，但是导线容易产生自旋，风机固定困难也增大，增加了调试难度。

　　方案二：摆杆使用硬质铁质材料，通过万向轴与横杆相连。用此材料强度能够达到要求，且风机固定容易。硬件搭建合理，配重平衡的前提下，摆杆来回摆动不易发生偏移，可轻松解决基本功能1，减少了编写代码的工作量。

综上考虑，我们选择方案二，节约时间。

1.2.4 摆杆与风机的连接选择

　　方案一：摆杆与风机之间使用一个直流电机或者舵机连接，这样可以随时改变风机的方向，同时可减少风机的数量，控制量减少。但是此方案连接结构较为复杂，发挥部分圆周运动稳定性不高。

　　方案二：摆杆与风机之间采用刚性连接，连接较为简单，稳定性能较好。

综上考虑，我们选择方案二。

#### 二、系统理论分析与计算

* 2.1风力摆位置的计算与分析

　　通过加速度计陀螺仪模块MPU6050检测风力摆摆杆的倾角数据。MPU6050集成了3轴MEMS陀螺仪，3轴MEMS加速度计。可根据三角函数公式，可计算出此时摆杆距离中心位置的距离(见图3）。内部有一个数字运动处理器DMP。MPU6050和所有设备寄存器之间通信采用400Khz的I2C接口，实现高速通信。测试过程中，MPU6050与单片机之间进行通信，距离较长，走线较多，干扰较大导致读数不准确，所以在SCL与SDA上拉2K电阻，解决采样问题。内置卡尔曼滤波器，采用最优化自回归数据处理算法精确测量风力摆当前姿态角。MPU6050对陀螺仪和加速度计分别采用了16位的ADC，将其测量的模拟量转化为可输出的数字量，通过DMP处理器读取测量数据然后通过串口输出。
<div align="center">
	<img src="/images/posts/fenglibai/3.png" height="200" width="500">  
</div>                                  

* 2.2风力摆运动状态的分析

　　基本功能1中属于开环控制系统，激光笔绘制的轨迹超过50cm即可。我们可以设置摆杆倾角超过一个阈值θ，θ可通过摆动半径R（R>=25cm）直接计算出。然后，通过开环调节，从低到高改变风机的风速，直到摆杆的角度超过阈值，记下此时PWM波脉宽级作用时间。

　　要绘制50cm直线，只需R>25cm（R为地面运动轨迹的一半）在平面内运动即可则其中L为摆杆与激光头的长度，a为激光头到地面的距离（a<=20cm）基本要求（2）摆动幅度可控，属于闭环控制系统，公式计算与（1）相同设置直线长度▽θ（30cm<▽θ<60cm）MPU6050将倾角，角速度送给单片机，单片机控制风机来产生推力使摆杆摆动。
<div align="center">
	<img src="/images/posts/fenglibai/4.png" height="200" width="500">  
</div> 

* 2.3控制算法的分析

　　系统采用PID算法来控制风机转动的速度，风机开始工作后，MPU6050不断采集当前摆杆摆脚状态，并与之前的状态进行比较，使得摆杆运动状态趋于稳定。PID算法控制器由4个风机速度分配比例P角度误差积分I角度微分D组成。
<div align="center">
	<img src="/images/posts/fenglibai/5.png" height="200" width="500">  
</div> 
 
在发挥功能时，要求做圆周运动。四个直流风机1、2、3、4,1和3用来使摆杆与重力方向呈现设置的夹角，2和4用来推动摆杆沿切线方向运动，这样通过控制1、3电机的PID参数使摆杆达到设定的角度，通过2和4推动摆杆，摆杆就会沿切线运动，绘制圆形轨迹。

#### 三、电路与程序设计

* 3.1部分电路详细原理图

<div align="center">
	<img src="/images/posts/fenglibai/6.png" height="300" width="500">  
</div> 


<div align="center">
	<img src="/images/posts/fenglibai/7.png" height="300" width="500">  
</div> 


<div align="center">
	<img src="/images/posts/fenglibai/8.png" height="300" width="500">  
</div> 


* 3.2电源

　　系统整体采用开关电源供电，最大可输出10A电流，空心杯电机平均所需电流为800MA，电源可满足需求。5V供给4个并联电机驱动带动风机转动，5V给单片机供电，单片机自带稳压输出3.3V给MPU6050供电，电机驱动本身也可稳压输出5V，给激光头（5V)供电。此系统中所有电源共地。

* 3.3程序的设计

3.3.1程序功能描述与设计思路

1、程序功能描述

　　系统采用独立按键控制进行模式选择，设置有5个按键，即五种模式:按键1~4分别代表4个基本模式，按键5代表发挥模式。使用12864液晶做显示模块，系统开机后进入初始化状态出现欢迎界面，然后通过按键进行模式选择，执行不同的要求。

2、程序设计思路

　　模式1即自由摆属于开环控制系统，通过粗略控制便可实现，设定倾角阈值，从低到高不断增加X风机转速，直到摆长超过阈值(50cm)，记录此时PWM脉宽级作用时间。模式2需要采用闭环控制算法，计算公式与1相同，设定好范围后，可与1使用相同的方法调试。功能3要采用受力分析，使用力的合成，通过计算达到设定角度。功能4为平衡扰动，即拉起一定角度后，如果不提供动力，摆杆将逐渐衰减，但是速度缓慢，因此需要提供与运动方向相反的力，阻碍摆杆运动。这个过程需要注意，实时采集摆杆的角度（比例项 P），进行 微分从而确定角速度（陀螺仪直接测量亦可），为微分项 D，采用类似于自平衡的 PD 控制算法 即可。发挥功能可以明确，径向风机控制采用PID控制算法，使摆杆稳定在某一设定角度，切线方向控制2、4电机产生推力，推动摆杆圆周运动。那么，很明显，关键在于如何使摆杆稳定在某一个角度（认为设定），使用PID算法即可，原理类似于基本功能4，只不过基本功能4将竖直方向（重力方向）视为设定值，而发挥部分中是将设定的半径转换成的角度视为设定值。

3.3.2程序流程图

1、主程序流程图                             
<div align="center">
	<img src="/images/posts/fenglibai/9.png" height="340" width="500">  
</div>

2、PID算法框图
<div align="center">
	<img src="/images/posts/fenglibai/10.png" height="220" width="500">  
</div>

#### 四、测试方案与测试结果

* 4.1测试方案

　　（1）驱动风机带动摆杆来回摆动，使激光头在地面上打出一条大于50cm的直线。记录由平衡位置到完成划线要求时所用的时间以及最大偏差距离。重复6次，记录在表1中。

　　（2）人为的设定激光头划线的长度，从30cm开始测量，记录到达规定长度所用时间和最大误差，测量3次，时间取平均值。然后依次记录40cm、50cm、60cm的数据，记录在表2中。

　　（3）人为的设定激光头划线的方向，使激光头在地面上打出一条大于20cm的直线。从0°直线开始。记录达到规定长度所用时间和最大误差，测量3次，时间取平均值。然后依次测量  90°、 180°、270°、360°直线，记录在表3中。

　　（4）将摆杆拉倒一定的角度然后放下，驱动风机，记录摆杆恢复到中心位置所用时间，记录在表4。

　　（5）以摆杆静止时的位置为圆心，设置画圆半径，记录激光头划线旋转3周后所用时间，以及偏差的最大距离，重复3次。然后改变半径长度，在一次测量，记录在表5中。

* 4.2测试条件与仪器

　　秒表、自制角度测量板、量角器、直尺、示波器、信号源（由于我们使用的空心杯是无刷电机，则使用电调精确控制速度需要信号源产生、示波器测量PWM波的频率、占空比等

* 4.3测试结果及分析

（1）测试结果                        
<div align="center">
	<img src="/images/posts/fenglibai/11.png" height="200" width="500">  
</div>


<div align="center">
	<img src="/images/posts/fenglibai/12.png" height="200" width="500">  
</div>


<div align="center">
	<img src="/images/posts/fenglibai/13.png" height="200" width="500">  
</div>


<div align="center">
	<img src="/images/posts/fenglibai/14.png" height="200" width="500">  
</div>


<div align="center">
	<img src="/images/posts/fenglibai/15.png" height="200" width="500">  
</div>


（2）测试分析与结论

　　根据上述测试数据，该风力摆控制系统已能达到基本部分和发挥部分的全部理想性能指标，由此可以得出以下结论：

　　1.风机的性能是决定系统能否完成题目要求的关键，风机性能由其本身决定，包括重量、产生的最大风速、以及所需的电流。任何一个达不到要求，将会给程序调控大大增加难度，所以硬件搭建很重要。

　　2.好的算法，也起到至关重要的作用，为了能达到题目要求，四个风机的速度分配比例很重要，这就需要良好的算法加合适的参数。

　　3.此控制系统，需要时间上的配合，时间参数同样重要，要能保证在规定时间内完成任务。

综上所述，本设计达到设计要求。

#### 六、参考文献

[1] 华成英，童诗白.模拟电子技术基础，第四版，清华大学出版社，2006.

[2] 求是科技.单片机典型模块设计实例导航.北京：人民邮电出版社，2004.

[3] 谭浩强.C程序设计.北京：清华大学出版社，1991.

[4]郭天祥.新概念51 单片机C 语言教程.入门、提高、开发[M].北京：电子工业出版社，2009.

[5] 阎石.数字电子技术基础（第五版）[M].北京:高等教育出版社,2009.

#### 七、调试心得
```
硬件方面：

1.首先，这个作品对硬件要求比较高，所以在搭建硬件时，一定得详细规划一下，比如四个电机必须对称；6050模块儿安装位置也得好好计划一下。

2.电源最好分为两路，分开给单片机和电机的供电。这样可避免对电机的干扰。

3.考虑摆杆重量这个因素，因为电机功率有限，太重便会造成“吹不起来”等现象。

软件方面：

1.务必先调节6050陀螺仪，因为他的值是整个算法的核心，它不准，后面也就没有调节的必要了。

2.12864选择串行输出方式，这样不仅便于控制，还可以节省大量IO口。

3.最后就是PID了，PID算法就是对偏差的比例（P）、积分（I）和微分（D）进行控制的调节算法。Pitch.Output = (int)(Pitch.Kp*Pitch.Err+Pitch.Ki*Pitch.Integral-Pitch.Kd*Pitch.Differ) ，（ROLL和其同理）
其中Pitch.Output是控制量，Pitch.Err是控制偏差，Kp是比例系数，T是系统采样周期，TI是积分时间，TD是微分时间。由于风力摆的实时性要求较高，要能够迅速对摆的运动做出响应，所以除了比例调节外，
必须要有微分调节，由于积分调节过程会增加调节时间，所以算法利用PD调节器进行偏差计算得到控制量。[Pitch.Err=set_angle-cur_angle]，其中Pitch.Err是摆的偏差，set_angle是摆的设定角度，cur_angle是采集到当前
摆的角度。通过上述算法式计算出控制量u（最后将控制量转变为PWM），利用计算出的PWM控制量控制风机速度，同时反复调整Kp和Kd值使控制系统运动性能符合要求。

　　调试完成后也可以尝试加一些创新之类的，比如写汉字等等功能。也希望上述内容能对读者有所帮助。
```
## 寄言

[需要本作品论文及源代码请戳这里！！！](https://github.com/henghengCSDN/Product/tree/master/%E9%A3%8E%E5%8A%9B%E6%91%86%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F)

谢谢大家的支持，如有不足，忘不吝赐教。

<br>

转载请注明原地址：[wonderheng的博客](http://www.wonderheng.top) » [点击阅读原文](https://www.wonderheng.top/2018/05/%E9%A3%8E%E5%8A%9B%E6%91%86%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F/)谢谢！